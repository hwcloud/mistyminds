---
layout: post
title:  新一代的App开发
categories: [web, mobile, app]
comments_id: 5
excerpt: 随着新的消费者设备的出现，新计算技术的普及以及全球新的软件供应链的改变，下一代的app开发已经浮出水面

---
移动App作为移动互联网最重要的商业模式已经成为1000亿美元的巨大市场，随着手机硬件升级速度的变慢，移动app的生态价值越加重要，当前的移动App生态由iOS和Android主动，移动web app在移动互联网早期发展中起到重要作用，但是也因为体验难以匹敌原生app，沦为二等公民，但是其开放的信息互联模型和分发方式依然有强大的竞争力。新一代的App发展受制于新体验、新生态和新技术等多方面的影响。

#### 1、	新的consumer device
例如：AR/VR，代表了新的spatial computing时代的到来，旧有的web和app平台是为了2D内容高度优化的，分发方式，变现方式也和3D 内容是不同的。基于unity的游戏引擎的技术在多人交互、开发式信息模型、可信产业链等多重挑战下不可能还可以一家独大。
#### 2、	生态的分裂，可信软件供应链
导致旧有的分发模式和商业模式的变化，针对不同的市场需要使用不同的app分发方式商业模式，全球市场分裂，出现了美系和中国市场之外的第三市场，这种分裂并不一定是负面的，对主导型的生态是负面的，对还在成长的生态则提供了一个机会，主要是海外的非美市场需要采取混合模式，全球美系super app的PWA方式转换，和非美app的HMS生态建设，开发者的技术和商业扶植。	
#### 3、	新技术的影响
web计算平台通过webassembly获得新的生命力，web应用可以获得性能和安全以及多语言编程，模糊了原生应用和web应用的边界，对未来3D内容的应用平台会是一个非常有竞争力的平台，以react为代表的基于声明式UX语言、组件化UX和云端融合的数据交互技术成为前端技术的主流，在大的潮流下出现了百花齐放的变种。
这些趋势都在驱动面向新时代的app开发模式的变革，利益格局将会重新分配

上文中已经讨论过了webassembly和基于webassembly和webXR构建AR/VR应用开发平台，这里主要讨论面向第三市场，通过新的技术体系，构建PWA开放app模式，和HMS海外生态体系构建。在第三市场，有两个关键性的问题，一个是PWA应用方式支持super app，它带来的价值是一站式到达的开启方式，只是对web网页的一种封装方式，如果支撑PWA运行的浏览器性能没有明显性能差异，PWA并不能够透明提升应用性能和交互体验。浏览器性能的主要取决于几个方面

#### 1、	渲染HTML/CSS的能力
 - CSS的并行化渲染能力，GPU渲染能力
 - HTML DOM 数据结构操作的效率
#### 2、	运行javascript脚本的能力
 - Javascript JIT 编译器的性能，JS是动态语言，虽然编译器已经取得很大进步，但是仍然很慢，尤其一些计算intensive的library
 - Javascript应用是单进程，web app需要使用webworker机制实现并行化提速
#### 3、	网页内容的下载和缓存
 - JS的所有页面需要下载，不能本地存储，对用户使用网页习惯的判断和预测，来优化缓存的使用
 - JS是文本代码，minimize的压缩比低，下载慢
  
  
从用户体验上，浏览器和原生app的差距

  - 原生app有本地存储能力，可以利用手机的sandbox安全机制，实现用户的长期登陆，不需要每次输入登陆信息，Super App里有不少是银行、支付等关键性的app，他们是高频应用同时对安全要求很高，原生app可以长期保持用户认证信息，可以利用手机的指纹识别、相机识别能力做快速用户登录认证，是友好体验的重要组成部分。
  - 访问本地设备能力，例如：影视频、蓝牙、照相机等
  - 更好的多任务机制，浏览器受制于安全模式，不能在背景运行，不满足导航、音视频播放、蓝牙IoT等应用
  
透明加速，指的是可以不修改web app，使用特定浏览器就可以获得性能提升，或者对web应用做一次重新编译发布，就可以获得提升，例如pwa builder。

最直接的办法是做更好的浏览器，但是显然，四大浏览器厂家在性能优化上做了这么多年的工作，能够做出性能更高的浏览器无疑是几乎不可能的。当然，如果把浏览器的应用范围缩小到特定领域，例如：webXR应用，特定的framework，针对framework加速是有可能达到比较高的性能的。Web app 领域，framework创新层出不穷，曾经是万马奔腾，但是现在也逐渐聚焦到几个框架了，react，angular，vue，ember，针对这些framework的加速办法有几类，jsx 是声明式编程，意味着jsx的render存在脱离浏览器加速的可能性，例如：重新构建一套简化的直接render的流程？因为不需要支持DOM API?

透明方式加速，即不需要web app做任何修改，就可以透明加速，这种方式下因为不能修改用户代码，性能的主要提升来做于CSS渲染，Javascript VM 性能提升，主要取决于浏览器厂家的进步速度，四大浏览器（Chromium, Gecko, Edge, Webkit）都是开源实现， 意味着不需要额外投资就可以跟着主干版本进步，例如：对Webassembly的支持，浏览器通过GPU支持CSS渲染。浏览器都采用C++语言开发，Mozilla 2006年为了提升浏览器并行并行计算的能力提出了RUST语言，为了让浏览器获得原生应用的性能，2013年提出了asm.js，进而演化为webassembly，这两个技术最终都被标准化，RUST语言成为C++语言的替代，webassembly在浏览器中提供多语言的运行环境，对浏览器未来的发展都已经产生了重大的影响。

RUST语言提出的初衷是为了能够通过并行化计算提升浏览器的性能，RUST语言具备when it compiles, it is safe的原则，支持更简单和安全的多进程编程模式。Mozilla 一直在开发基于RUST的servo浏览器项目，servo的css 渲染性能确实很出色，servo中的核心css渲染引擎已经被植入到firefox quantum浏览器，servo项目本身被用于支持AR/VR应用的firefox reality浏览器，因为这些应用对稳定和高速的3D图像渲染有更严格的要求，并且不需要支持传统的2D的大量技术负债。


另外一种透明加速是对特定popular的web framework，例如：react, angular, VUE等，可以通过替换其特定组件实现加速，PWA应用体验很重要的一方面是离线体验，在上述前端框架中GraphQL越来越多用于和后台数据服务的交互，基于GraphQL实现的本地缓存和离线sync 机制简化了PWA应用开发，其他的noBackend技术例如pounchDB，Howdie等也被用于简化前端离线数据访问和后端数据源的同步。


  - 浏览器CSS render通过GPU实现，这个思路
  - 使用react框架的web app，通过JSX的链接到私有DOM实现而实现加速，例如：ReactDOM




非透明加速，应用需要做适配，轻量级适配例如通过特殊的html/css tag来触发特别渲染能力，重量级适配需要使用特定的framework和高效编程语言
  - 因为浏览器的迭代速度很慢，很多重度使用graphics渲染的公司在浏览器内做一套私有的CSS渲染机制，所谓的browser in browser，最典型如，flipboard电子杂志的react-canvas通过canvas机制在实现部分高性能scrolling和翻页等UX机制，这种特别渲染的触发基于自定义的HTML tag，实现了和CSS混合渲染的效果。Figma完全实现自己基于C++和webgl的2D 图像编辑引擎，通过Webassembly运行在浏览器内，当然它的html网页内部的渲染都是自己引擎接管了。
  - 另一种是用高性能语言取代Javascript，因为webassembly已经可以支持对DOM操作，例如：微软的blazor使用C#替代Javascript作为web app的编程语言，asm-dom使用C++编译为webassembly作为web app的编程语言（https://github.com/mbasso/asm-dom），yew使用RUST语言作为web框架的编程语言（https://github.com/flosse/rust-web-framework-comparison#frontend-frameworks-wasm）。
  - 对一些web app的计算密集模块做Webassembly的卸载，通过API提供能力给javascript应用，构建混合应用，例如：音视频编解码器，物理引擎，Canvas，SVG渲染能力

![web app 架构](../images/webapp.png)



从用户体验上来看，web app可以做改进来缩小和原生app在交互体验上的差距
  - 和手机的认证机制紧密结合，支持faceid，指纹登陆等，这个需要对app做改变，需要和auth0等id提供商合作
  - 和手机的设备访问能力集成，设备能力通过WASI暴露给WASM，WASM使用C/C++，RUST高性能语言开放，提供给web app，可靠访问camera、bluetooth、音视频player
  - 支持更好的多任务机制，支持web app在背景运行，对于音乐、地图类应用很关键


随着Webassembly的支持，Webassembly system interface types的逐步完善，web成为非常类似传统操作系统的计算平台，即浏览器未来的发展会向基础计算能力发展，强调性能、安全和对硬件平台的优化和对设备的支持，而业务层的创新将会在Webassemly层进行，最典型WebXR、Web Machine learning这样的特性，完全可以由应用开发者自由发挥，通过技术和生态的竞争决出胜负，而不需要W3C这样的标准组织通过标准的方式来判决胜负。这种趋势将会导致web平台和android、iOS直接竞争，但是因为web并不被单一厂家控制，而且通过webassembly这层抽象，也脱离了对单一编程语言的依赖，同时还继承了 web的超链接开放信息模型和Internet庞大基础设施的支持，new web平台在多样性和bottom up创新上的竞争力不可小觑。




